<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Jasa Pekerja Tani Tuban</title>
  <meta name="theme-color" content="#22c55e" />
  <link rel="manifest" href="manifest.json" />

  <style>
    body{font-family:sans-serif;margin:0;background:#f0fdf4;color:#1e293b}
    header{background:#22c55e;color:#fff;display:flex;align-items:center;justify-content:center;padding:20px;gap:10px}
    header img{height:40px;border-radius:6px}
    header h1{margin:0;font-size:1.5rem}
    .container{max-width:800px;margin:auto;padding:20px}
    form{background:#fff;padding:20px;border-radius:10px;margin-bottom:30px;box-shadow:0 2px 6px rgba(0,0,0,.1)}
    input,textarea{width:100%;padding:10px;margin:10px 0;border:1px solid #ccc;border-radius:6px}
    button{background:#22c55e;color:#fff;padding:12px;width:100%;border:none;border-radius:6px;font-size:1rem;cursor:pointer}
    .job-card{background:#fff;border-radius:10px;box-shadow:0 2px 4px rgba(0,0,0,.1);padding:20px;margin-bottom:20px;position:relative}
    .job-card h3{margin:0 0 10px}
    .job-card a,.job-card button.mark-terisi{background:#16a34a;color:#fff;padding:8px 12px;border-radius:5px;text-decoration:none;display:inline-block;margin-top:10px}
    .job-card.terisi{opacity:.5}
    footer{text-align:center;font-size:.9rem;color:#6b7280;margin-top:40px}
  </style>
</head>

<body>
  <header>
    <img src="Logo.png" alt="Logo">
    <h1>Jasa Pekerja Tani Tuban</h1>
  </header>

  <div class="container">
    <h2>Pasang Lowongan</h2>
    <form id="formPekerjaan">
      <input type="text" id="judul" placeholder="Judul Pekerjaan" required />
      <input type="date" id="tanggal" required />
      <input type="text" id="upah" placeholder="Upah (Rp)" required />
      <textarea id="deskripsi" placeholder="Deskripsi Pekerjaan" required></textarea>
      <input type="text" id="wa" placeholder="Nomor WA (628xxxxxx)" required />
      <button type="submit">üì¢ Pasang Lowongan</button>
    </form>

    <h2>üìã Daftar Lowongan</h2>
    <div id="daftarLowongan"><p>Memuat data...</p></div>
  </div>

  <footer>
    Dibuat oleh <a href="https://wa.me/6289607633666" target="_blank">Mr.&nbsp;Begox&nbsp;Ndangun</a>
  </footer>

  <!-- Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js')
        .then(() => console.log('‚úÖ Service Worker aktif'))
        .catch(err => console.log('‚ùå SW gagal:', err));
    }
  </script>

  <!-- Firebase¬†compat CDN (tanpa ES¬†module) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

  <script>
    /* Konfigurasi¬†Firebase */
    const firebaseConfig = {
      apiKey: "AIzaSyBk-lH9FOn2qzuJgjYJAhL6z4KuiCzI8zA",
      authDomain: "jasa-pekerja-tani-tuban.firebaseapp.com",
      projectId: "jasa-pekerja-tani-tuban",
      storageBucket: "jasa-pekerja-tani-tuban.appspot.com",
      messagingSenderId: "865622442089",
      appId: "1:865622442089:web:20a149b7f101957594a2f8",
      measurementId: "G-2KLMXXT0TY"
    };

    /* Inisialisasi */
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    /* Submit Form */
    document.getElementById('formPekerjaan').addEventListener('submit', async (e) => {
      e.preventDefault();

      const judul     = document.getElementById('judul').value.trim();
      const tanggal   = document.getElementById('tanggal').value;
      const upah      = document.getElementById('upah').value.trim();
      const deskripsi = document.getElementById('deskripsi').value.trim();
      const wa        = document.getElementById('wa').value.trim();

      try {
        await db.collection('pekerjaan').add({
          judul, tanggal, upah, deskripsi, wa,
          status: 'tersedia',
          dibuat: firebase.firestore.FieldValue.serverTimestamp()
        });
        alert('‚úÖ Lowongan berhasil ditambahkan!');
        e.target.reset();
        tampilkanLowongan();
      } catch (err) {
        alert('‚ùå Gagal menyimpan: ' + err.message);
        console.error(err);
      }
    });

    /* Menampilkan Lowongan */
    async function tampilkanLowongan() {
      const container = document.getElementById('daftarLowongan');
      container.innerHTML = '<p>Memuat‚Ä¶</p>';

      const snapshot = await db.collection('pekerjaan').orderBy('dibuat','desc').get();
      container.innerHTML = '';

      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const el   = document.createElement('div');
        el.className = 'job-card' + (data.status === 'terisi' ? ' terisi' : '');

        el.innerHTML = `
          <h3>${data.judul}</h3>
          <p><strong>Tanggal:</strong> ${data.tanggal}</p>
          <p><strong>Upah:</strong> ${data.upah}</p>
          <p>${data.deskripsi}</p>
          <a href="https://wa.me/${data.wa}" target="_blank">üì≤ Saya¬†Tertarik</a>
          ${
            data.status === 'tersedia'
              ? '<button class="mark-terisi">‚úÖ Tandai¬†Sudah¬†Terisi</button>'
              : '<p><em>‚ùå¬†Sudah¬†Terisi</em></p>'
          }
        `;

        /* Tombol ‚ÄúTandai¬†Sudah¬†Terisi‚Äù */
        const btn = el.querySelector('.mark-terisi');
        if (btn) {
          btn.addEventListener('click', async () => {
            await db.collection('pekerjaan').doc(docSnap.id).update({ status: 'terisi' });
            tampilkanLowongan();
          });
        }
        container.appendChild(el);
      });

      if (!container.children.length) {
        container.innerHTML = '<p>Belum ada lowongan.</p>';
      }
    }

    /* Panggil pertama kali */
    tampilkanLowongan();
  </script>
</body>
</html>
